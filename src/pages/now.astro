---
import BaseLayout from "../layouts/BaseLayout.astro";

// Load now queue data at build time
let nowData: { exportedAt: string; resources: NowResource[] } = {
	exportedAt: new Date().toISOString(),
	resources: [],
};

interface NowResource {
	id: string;
	source: string;
	type: string;
	title: string;
	url: string;
	author: string | null;
	description: string | null;
	imageUrl: string | null;
	status: "now" | "next";
	queuePriority: number | null;
	platformStatus: string | null;
	favorited: boolean;
	rating: number | null;
}

try {
	const response = await fetch(new URL("/data/now.json", import.meta.url));
	if (response.ok) {
		nowData = await response.json();
	}
} catch {
	// File doesn't exist yet or fetch failed, use empty data
}

// In dev/build, try direct import as fallback
if (nowData.resources.length === 0) {
	try {
		const file = await import("../../public/data/now.json");
		nowData = file.default as typeof nowData;
	} catch {
		// Ignore
	}
}

const { resources } = nowData;

// Group by status
const nowItems = resources.filter((r) => r.status === "now");
const nextItems = resources.filter((r) => r.status === "next");

// Group by type for display
function groupByType(items: NowResource[]) {
	const groups: Record<string, NowResource[]> = {};
	for (const item of items) {
		const type = item.type;
		if (!groups[type]) groups[type] = [];
		groups[type].push(item);
	}
	return groups;
}

const nowByType = groupByType(nowItems);
const nextByType = groupByType(nextItems);

// Type display config with aspect ratios
const typeConfig: Record<string, { emoji: string; label: string; showPosters: boolean; aspect: string }> = {
	book: { emoji: "ðŸ“š", label: "Reading", showPosters: true, aspect: "aspect-[2/3]" },
	movie: { emoji: "ðŸŽ¬", label: "Film", showPosters: true, aspect: "aspect-[2/3]" },
	game: { emoji: "ðŸŽ®", label: "Playing", showPosters: true, aspect: "aspect-[2/3]" },
	album: { emoji: "ðŸŽµ", label: "Albums", showPosters: true, aspect: "aspect-square" },
	article: { emoji: "ðŸ“°", label: "Articles", showPosters: false, aspect: "" },
	paper: { emoji: "ðŸ“„", label: "Papers", showPosters: false, aspect: "" },
	video: { emoji: "ðŸ“º", label: "Videos", showPosters: false, aspect: "" },
};

// Preferred order for media types (no tracks, only albums)
const typeOrder = ["book", "movie", "game", "album", "article", "paper", "video"];

function sortedTypes(groups: Record<string, NowResource[]>) {
	return Object.entries(groups).sort(([a], [b]) => {
		const aIdx = typeOrder.indexOf(a);
		const bIdx = typeOrder.indexOf(b);
		return (aIdx === -1 ? 999 : aIdx) - (bIdx === -1 ? 999 : bIdx);
	});
}

const pageTitle = "Now";
const pageDescription = "What I'm consuming and what's up next.";
---

<BaseLayout pageTitle={pageTitle}>
	<h1 class="text-4xl font-bold mb-2">{pageTitle}</h1>
	<p class="text-gray-600 dark:text-gray-400 mb-10">{pageDescription}</p>

	{resources.length === 0 ? (
		<div class="text-gray-500 dark:text-gray-400 py-8">
			<p>Nothing in the queue yet.</p>
			<p class="text-sm mt-2">
				Run <code class="bg-gray-100 dark:bg-gray-800 px-1 rounded">bun sync all</code> then{" "}
				<code class="bg-gray-100 dark:bg-gray-800 px-1 rounded">bun sync --export-now</code> to populate.
			</p>
		</div>
	) : (
		<div class="space-y-16">
			{/* Currently Consuming */}
			{nowItems.length > 0 && (
				<section>
					<h2 class="text-2xl font-semibold mb-8 flex items-center gap-3">
						<span class="w-3 h-3 bg-green-500 rounded-full"></span>
						Now
					</h2>
					<div class="space-y-10">
						{sortedTypes(nowByType).map(([type, items]) => {
							const config = typeConfig[type] || { emoji: "ðŸ“¦", label: type, showPosters: false };
							return (
								<div>
									<h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-4">
										{config.emoji} {config.label}
									</h3>
									{config.showPosters ? (
										<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
											{items.map((item) => (
												<a
													href={item.url || "#"}
													target="_blank"
													rel="noopener noreferrer"
													class="group block"
												>
													<div class="aspect-[2/3] bg-gray-100 dark:bg-gray-800 rounded-lg overflow-hidden shadow-md group-hover:shadow-lg transition-shadow">
														{item.imageUrl ? (
															<img
																src={item.imageUrl}
																alt={item.title}
																class="w-full h-full object-cover"
															/>
														) : (
															<div class="w-full h-full flex items-center justify-center text-4xl">
																{config.emoji}
															</div>
														)}
													</div>
													<p class="mt-2 text-sm font-medium truncate group-hover:underline">
														{item.title}
													</p>
													{item.author && (
														<p class="text-xs text-gray-500 dark:text-gray-400 truncate">
															{item.author}
														</p>
													)}
												</a>
											))}
										</div>
									) : (
										<ul class="space-y-2">
											{items.map((item) => (
												<li class="flex items-center gap-2">
													<a
														href={item.url || "#"}
														target="_blank"
														rel="noopener noreferrer"
														class="hover:underline"
													>
														{item.title}
													</a>
													{item.author && (
														<span class="text-sm text-gray-500 dark:text-gray-400">
															â€” {item.author}
														</span>
													)}
												</li>
											))}
										</ul>
									)}
								</div>
							);
						})}
					</div>
				</section>
			)}

			{/* Up Next */}
			{nextItems.length > 0 && (
				<section>
					<h2 class="text-2xl font-semibold mb-8 flex items-center gap-3">
						<span class="w-3 h-3 border-2 border-blue-500 rounded-full"></span>
						Up Next
					</h2>
					<div class="space-y-10">
						{sortedTypes(nextByType).map(([type, items]) => {
							const config = typeConfig[type] || { emoji: "ðŸ“¦", label: type, showPosters: false };
							return (
								<div>
									<h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-4">
										{config.emoji} {config.label}
									</h3>
									{config.showPosters ? (
										<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
											{items.map((item) => (
												<a
													href={item.url || "#"}
													target="_blank"
													rel="noopener noreferrer"
													class="group block"
													title={item.title}
												>
													<div class="aspect-[2/3] bg-gray-100 dark:bg-gray-800 rounded-lg overflow-hidden shadow-md group-hover:shadow-lg transition-shadow">
														{item.imageUrl ? (
															<img
																src={item.imageUrl}
																alt={item.title}
																class="w-full h-full object-cover"
															/>
														) : (
															<div class="w-full h-full flex items-center justify-center text-4xl">
																{config.emoji}
															</div>
														)}
													</div>
													<p class="mt-2 text-sm font-medium truncate group-hover:underline">
														{item.title}
													</p>
												</a>
											))}
										</div>
									) : (
										<ul class="space-y-1">
											{items.map((item) => (
												<li class="flex items-center gap-2 text-sm">
													<a
														href={item.url || "#"}
														target="_blank"
														rel="noopener noreferrer"
														class="hover:underline"
													>
														{item.title}
													</a>
													{item.author && (
														<span class="text-gray-500 dark:text-gray-400">
															â€” {item.author}
														</span>
													)}
												</li>
											))}
										</ul>
									)}
								</div>
							);
						})}
					</div>
				</section>
			)}
		</div>
	)}

	<footer class="text-sm text-gray-400 dark:text-gray-500 mt-16 pt-6 border-t border-gray-200 dark:border-gray-700">
		<p>
			Last updated: {new Date(nowData.exportedAt).toLocaleDateString("en-US", {
				year: "numeric",
				month: "long",
				day: "numeric",
			})}
		</p>
	</footer>
</BaseLayout>
