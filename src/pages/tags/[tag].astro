---
import { getCollection } from "astro:content";
import BlogPost from "../../components/BlogPost.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";

export async function getStaticPaths() {
	const waves = await getCollection("waves");
	const depths = await getCollection("depths");
	const allPosts = [...waves, ...depths];

	const uniqueTags = [...new Set(allPosts.flatMap((post) => post.data.tags))];

	return uniqueTags.map((tag) => {
		const filteredPosts = allPosts
			.filter((post) => post.data.tags.includes(tag))
			.sort(
				(a, b) =>
					new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime(),
			);
		return {
			params: { tag },
			props: { posts: filteredPosts },
		};
	});
}

type Post = {
	id: string;
	data: { title: string; pubDate: Date; tags: string[] };
	collection: "waves" | "depths";
};

const { tag } = Astro.params;
const { posts } = Astro.props as { posts: Post[] };
---

<BaseLayout pageTitle={tag}>
	<h1 class="text-4xl font-bold mb-4">#{tag}</h1>
	<p class="text-gray-600 dark:text-gray-400 mb-6">
		{posts.length} post{posts.length !== 1 ? "s" : ""}
	</p>
	<ul>
		{posts.map((post) => (
			<BlogPost
				url={post.collection === "waves" ? `/posts/${post.id}` : `/depths/${post.id}`}
				title={post.data.title}
				date={new Date(post.data.pubDate).toLocaleDateString("en-US", {
					month: "short",
					year: "2-digit",
				})}
			/>
		))}
	</ul>
</BaseLayout>
